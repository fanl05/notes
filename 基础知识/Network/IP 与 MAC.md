# IP 与 MAC

**MAC 地址是什么？**

网卡出厂时会有一个 MAC 地址作为唯一编号，由 6 个字节组成，如 00-16-EA-AE-3C-40，前三个字节表示网络硬件厂商编号，后三个字节表示网卡序列号，是全球唯一的地址。

交换机将其端口号与设备的 MAC 地址进行绑定

**为什么手机连接 WIFI 后不用配置 IP 地址也可以正常使用？**

DHCP 协议自动配置 IP 地址：当电脑接上网线或手机连上 WIFI 后，操作系统网络协议栈会自动向外发送一条 DHCP 请求，请求为其分配 IP 地址，路由器收到请求后会为其分配 IP 地址，并通过 DHCP 报文发送回去，操作系统收到报文后会将其配置到网卡上。可以将 DHCP 关闭，手动配置 IP 地址。同一局域网内，IP 地址是唯一的。

**MAC 地址是由操作系统来补齐的，那么操作系统是如何知道对方的 MAC 地址的呢？**

ARP 协议：当计算机 A 想向计算机 B 发送消息时，操作系统会先发送一包 ARP 广播报文出去，网络中的其他设备都会收到这一包请求，除了计算机 B 以外的设备都会丢弃，而计算机 B 会回复自己的 MAC 地址是多少，计算机 A 收到后会缓存计算机 B 的 MAC 地址以便下次使用。随后计算机 A 将请求的报文补全，包括了目标 IP 地址，目标 MAC 地址和消息内容，通过网卡发送出去，交换机通过数据包中的目标 MAC 地址找到了计算机 B 所在的端口，并从此端口发送出去，计算机 B 就收到了。

**交换机是什么？**

交换机的主要功能是数据包发送到正确到正确的位置。一台交换机有很多端口，计算机连接到交换机的网口上，端口就是确定的位置，所以交换机中有一张端口号与 MAC 地址的映射关系表，及 MAC 地址表。想与某个 MAC 地址通信时，只需要查找 MAC 地址表，并送对应的端口发送出去。

数据包包括了源 MAC 和目标 MAC，当交换机接受到数据包时，先将源 MAC 地址与接受端口绑定，填入 MAC 地址表。接着根据目标 MAC 查找发出端口，分为两种情况：

1. 查找到了关联端口，就从该端口发出；
2. 未查找到关联端口，则向除了接受端口外的其他所有端口群发，即泛洪。如果目标 MAC 地址在该网络中，则一定能收到。

运行一段时间后，就可以通过 MAC 地址表查到该网络中的所有网络设备。交换机只关心 MAC 地址，不关心 IP 地址。MAC 地址位于 OSI 七层协议中的第二层，数据链路层，所以交换机也被称为二层设备。

**网关是什么？**

子网划分：IP 与子网掩码按位相与结果相同的两个 IP 认为在同一个子网中；

IP/掩码表示子网，如 192.168.1.0/24，则该网络中有 255 个 IP。处于不同子网的设备是不能直接通信的，需要通过网关来进行转发，网关上有两张网卡，分别配置了两个网络的 IP 地址，可以在两个网络之间转发数据包。

当子网 a 中的计算机1发送数据包时，首先会根据目标 IP 判断是否跟自己处于同一子网，如果是则直接从网卡发出，如果不是则将数据包的目标 MAC 地址改为网关 MAC 地址并发送给网关，网关再根据路由表查询到这一包数据属于子网 b，修改目标 MAC 地址为计算机2 的 MAC 地址，修改源 MAC 为自己的 MAC 并从子网 b 的网卡发出。

根据目标 IP 判断如何发送的行为称为**路由**。

**路由器是什么？**

路由器的接口分为 LAN 口和 WAN 口，LAN 口有多个可以用来接家庭网络设备，通过 WIFI 连接也相当于接入 LAN 口；WAN 口只有一个用来接入运营商网络。如果将路由器的 WAN 口忽略，其就是一台交换机。

LAN 口与 WAN 口属于不同的子网，属于跨网络行为，需要路由器担任网关的角色，它的行为就是路由。

## 家庭网络与英特网

**什么是 SNAT？**

在两个不同的家庭中，通过路由器接入的两台电脑 IP 都是 192.168.1.10，同时访问互联网上一个网站时，为什么 IP 不会冲突呢？

将数据包从路由器发出去时变成不同的 IP 地址，即 SNAT, 源地址转换技术。

计算机 IP: 192.168.1.10

路由器网关 IP: 192.168.1.1

路由器公网 IP: 221.8.14.91

访问的远端 IP: 36.152.44.96

数据包收到计算机发出的数据包时，会进行 SNAT，将源 IP 改成 WAN 口的公网 IP 221.8.14.91 进行转发。目标服务器进行处理并回复，路由器收到回复执行反向 SNAT，即 UNSNAT，将目标 IP 改为 192.168.1.10，发送给家庭中的计算机。

当家庭中两台设备同时访问一个目标服务器，目标服务器返回的数据包路由器无法区分属于哪一台设备，所以 SNAT 不仅会修改源 IP，对于 TCP 协议还会修改源端口。如设备1和设备2的端口都是 12345，那么 SNAT 就会将其分别转换为 23456 和 34567，反向 SNAT 时路由器根据转换后的端口区分是属于主机1还是主机2的数据包。UDP 也会修改端口号，ping 命令使用 ICMP 协议，修改 IP 地址和 type + code，其他协议类似，使用 IP 地址 + 其他标记进行关联。

**什么是 DNAT？**

目标地址转换，如果内网计算机对外提供服务，公网上发来的请求不能直接到达内网计算机，需要路由器使用 DNAT 技术转发请求。

如一台内网计算机启动了 Web 服务，监听 80 端口，则需要在路由器上配置 DNAT，8080->192.168.1.10:80，修改目标 IP 为 192.168.1.10，修改目标端口为 80，即访问公网地址的 8080 端口则转发到内网计算机 192.168.1.10 的 80 端口。

NAT 技术缓解了 IPV4 资源匮乏的问题。

